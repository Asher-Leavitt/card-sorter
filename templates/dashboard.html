<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Sorter â€” Control Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0a0c10;
    --surface:   #12151c;
    --surface2:  #1a1e28;
    --surface3:  #222733;
    --border:    #2a2f3c;
    --text:      #c4c9d6;
    --text-dim:  #5a6070;
    --white:     #eaedf4;
    --accent:    #4ade80;
    --accent2:   #22c55e;
    --accent-bg: #122a1e;
    --red:       #f87171;
    --red-bg:    #2a1218;
    --yellow:    #fbbf24;
    --yellow-bg: #2a2412;
    --blue:      #60a5fa;
    --blue-bg:   #12202a;
    --purple:    #a78bfa;
    --mono:      'JetBrains Mono', monospace;
    --sans:      'DM Sans', sans-serif;
    --radius:    10px;
    --radius-sm: 6px;
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    line-height: 1.55;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 28px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo {
    font-family: var(--mono); font-size: 15px; font-weight: 700;
    letter-spacing: 0.08em; text-transform: uppercase; color: var(--accent);
  }
  .badge {
    font-family: var(--mono); font-size: 10px; font-weight: 600;
    padding: 3px 10px; border-radius: 99px; border: 1px solid;
    letter-spacing: 0.04em;
  }
  .badge.sim  { color: var(--yellow); border-color: var(--yellow); background: var(--yellow-bg); }
  .badge.live { color: var(--accent); border-color: var(--accent); background: var(--accent-bg); }
  .header-dots { display: flex; gap: 6px; }
  .header-dots span { width: 8px; height: 8px; border-radius: 50%; }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .layout {
    display: grid;
    grid-template-columns: 340px 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 1px;
    background: var(--border);
    min-height: calc(100vh - 50px);
  }
  @media (max-width: 1100px) {
    .layout { grid-template-columns: 1fr 1fr; }
    .card-panel { grid-column: 1 / -1; grid-row: 1; }
  }
  @media (max-width: 700px) {
    .layout { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--surface);
    padding: 22px;
    overflow: hidden;
  }
  .panel-head {
    font-family: var(--mono); font-size: 10px; font-weight: 600;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .panel-head .pip {
    width: 7px; height: 7px; border-radius: 2px;
    display: inline-block;
  }
  .full-width { grid-column: 1 / -1; }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    font-family: var(--mono); font-size: 12px; font-weight: 600;
    padding: 8px 16px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); cursor: pointer;
    transition: all 0.12s; background: var(--surface2); color: var(--text);
    white-space: nowrap;
  }
  .btn:hover { border-color: var(--text-dim); background: var(--surface3); }
  .btn:active { transform: scale(0.97); }
  .btn.g { background: var(--accent-bg); border-color: var(--accent2); color: var(--accent); }
  .btn.g:hover { background: var(--accent); color: var(--bg); }
  .btn.r { background: var(--red-bg); border-color: var(--red); color: var(--red); }
  .btn.r:hover { background: var(--red); color: var(--bg); }
  .btn.b { background: var(--blue-bg); border-color: var(--blue); color: var(--blue); }
  .btn.b:hover { background: var(--blue); color: var(--bg); }
  .btn.sm { padding: 5px 10px; font-size: 11px; }
  .btn-row { display: flex; gap: 6px; flex-wrap: wrap; }

  /* â”€â”€ Indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .indicators { display: flex; gap: 18px; flex-wrap: wrap; margin-bottom: 16px; }
  .ind {
    display: flex; align-items: center; gap: 7px;
    font-family: var(--mono); font-size: 12px;
  }
  .dot {
    width: 9px; height: 9px; border-radius: 50%;
    background: var(--surface3); transition: all 0.2s; flex-shrink: 0;
  }
  .dot.on  { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
  .dot.wrn { background: var(--yellow); box-shadow: 0 0 10px var(--yellow); }
  .dot.err { background: var(--red);    box-shadow: 0 0 10px var(--red); }

  /* â”€â”€ Slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .slider-row {
    display: flex; align-items: center; gap: 10px; margin-top: 10px;
  }
  .slider-row label {
    font-family: var(--mono); font-size: 11px;
    color: var(--text-dim); min-width: 44px;
  }
  input[type="range"] {
    -webkit-appearance: none; flex: 1; height: 3px;
    background: var(--border); border-radius: 2px; outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    border-radius: 50%; background: var(--accent); cursor: pointer;
  }
  .slider-val {
    font-family: var(--mono); font-size: 11px;
    color: var(--white); min-width: 48px; text-align: right;
  }

  /* â”€â”€ Current Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card-panel { grid-row: 1 / 3; }
  .card-view {
    display: flex; flex-direction: column; align-items: center;
    gap: 16px;
  }
  .card-img-wrap {
    width: 100%; max-width: 280px; aspect-ratio: 488 / 680;
    border-radius: 14px; overflow: hidden;
    background: var(--surface2); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .card-img-wrap img {
    width: 100%; height: 100%; object-fit: cover;
    border-radius: 14px;
  }
  .card-img-placeholder {
    color: var(--text-dim); font-family: var(--mono); font-size: 12px;
    text-align: center; padding: 20px;
  }
  .card-info { width: 100%; }
  .card-name {
    font-size: 20px; font-weight: 700; color: var(--white);
    line-height: 1.2; margin-bottom: 4px;
  }
  .card-type {
    font-size: 13px; color: var(--text-dim); margin-bottom: 10px;
    font-style: italic;
  }
  .card-meta-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px;
  }
  .meta-item {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 8px 10px;
  }
  .meta-label {
    font-family: var(--mono); font-size: 9px; font-weight: 600;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 2px;
  }
  .meta-value {
    font-family: var(--mono); font-size: 14px; font-weight: 700;
    color: var(--white);
  }

  /* Color pips */
  .color-pips { display: flex; gap: 4px; }
  .cpip {
    width: 20px; height: 20px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: #000;
    border: 2px solid rgba(255,255,255,0.15);
  }
  .cpip.W { background: #f9f5dd; }
  .cpip.U { background: #0e68ab; color: #fff; }
  .cpip.B { background: #2b2a2a; color: #ccc; }
  .cpip.R { background: #d3202a; color: #fff; }
  .cpip.G { background: #00733e; color: #fff; }
  .cpip.C { background: #8e8a86; }

  .pile-badge {
    display: inline-block; font-family: var(--mono);
    font-size: 13px; font-weight: 700; padding: 4px 14px;
    border-radius: 99px; background: var(--accent-bg);
    color: var(--accent); border: 1px solid var(--accent);
    margin-top: 10px;
  }

  /* â”€â”€ Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .rule-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 10px 12px;
    margin-bottom: 6px; display: flex; align-items: center;
    gap: 6px; flex-wrap: wrap;
  }
  .rule-card select, .rule-card input {
    background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: 4px; padding: 5px 7px; font-family: var(--mono);
    font-size: 11px;
  }
  .rule-card select:focus, .rule-card input:focus {
    outline: none; border-color: var(--accent);
  }
  .rule-card .rule-name { width: 100px; }
  .rule-card .rule-field { width: 110px; }
  .rule-card .rule-op { width: 80px; }
  .rule-card .rule-val { width: 90px; }
  .rule-card .rule-pile { width: 50px; text-align: center; }
  .rule-card .rule-del { flex-shrink: 0; }
  .rule-arrow {
    font-family: var(--mono); font-size: 11px; color: var(--text-dim);
    flex-shrink: 0;
  }
  .rules-scroll { max-height: 380px; overflow-y: auto; }

  /* â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .log-scroll { max-height: 360px; overflow-y: auto; }
  .log-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 7px 10px; border-bottom: 1px solid var(--border);
    font-size: 13px; gap: 8px;
  }
  .log-row:last-child { border-bottom: none; }
  .log-name { font-weight: 600; color: var(--white); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .log-detail { font-family: var(--mono); font-size: 10px; color: var(--text-dim); }
  .log-pile {
    font-family: var(--mono); font-size: 10px; padding: 2px 8px;
    border-radius: 99px; background: var(--surface3); border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .log-empty { color: var(--text-dim); font-style: italic; padding: 16px; text-align: center; }

  /* â”€â”€ Sim box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sim-box {
    background: var(--yellow-bg); border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius); padding: 14px; margin-top: 14px;
  }
  .sim-box h3 {
    font-family: var(--mono); font-size: 11px; font-weight: 600;
    color: var(--yellow); margin-bottom: 10px;
    letter-spacing: 0.06em; text-transform: uppercase;
  }
  .sim-fields { display: flex; gap: 6px; flex-wrap: wrap; align-items: end; }
  .sim-f { display: flex; flex-direction: column; gap: 2px; }
  .sim-f label {
    font-family: var(--mono); font-size: 9px; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--text-dim);
  }
  .sim-f input {
    background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: 4px; padding: 6px 8px; font-family: var(--mono); font-size: 12px;
  }
  .sim-f input:focus { outline: none; border-color: var(--yellow); }

  /* Search results dropdown */
  .search-results {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    max-height: 260px; overflow-y: auto; z-index: 100;
    display: none;
  }
  .search-results.open { display: block; }
  .sr-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; cursor: pointer; border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .sr-item:hover { background: var(--surface3); }
  .sr-item img { width: 32px; border-radius: 3px; flex-shrink: 0; }
  .sr-item .sr-name { font-size: 13px; font-weight: 600; color: var(--white); }
  .sr-item .sr-set { font-size: 11px; color: var(--text-dim); }
  .search-wrap { position: relative; }

  /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- â•â•â• Header â•â•â• -->
<div class="header">
  <div class="header-left">
    <span class="logo">ğŸƒ Card Sorter</span>
    <span class="badge {{ 'sim' if simulated else 'live' }}">
      {{ 'SIM MODE' if simulated else 'LIVE' }}
    </span>
  </div>
  <div class="header-dots">
    <span id="hd1" style="background:var(--surface3)"></span>
    <span id="hd2" style="background:var(--surface3)"></span>
    <span id="hd3" style="background:var(--surface3)"></span>
  </div>
</div>

<!-- â•â•â• Grid â•â•â• -->
<div class="layout">

  <!-- â”€â”€ Current Card â”€â”€ -->
  <div class="panel card-panel">
    <div class="panel-head"><span class="pip" style="background:var(--purple)"></span> Current Card</div>
    <div class="card-view" id="cardView">
      <div class="card-img-wrap">
        <div class="card-img-placeholder" id="cardImgArea">
          Scan a card to see it here
        </div>
      </div>
      <div class="card-info" id="cardInfo" style="display:none">
        <div class="card-name" id="cardName"></div>
        <div class="card-type" id="cardType"></div>
        <div class="card-meta-grid">
          <div class="meta-item">
            <div class="meta-label">CMC</div>
            <div class="meta-value" id="cardCmc">â€”</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Price</div>
            <div class="meta-value" id="cardPrice">â€”</div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Colors</div>
            <div class="meta-value" id="cardColors"><span style="color:var(--text-dim)">â€”</span></div>
          </div>
          <div class="meta-item">
            <div class="meta-label">Rarity</div>
            <div class="meta-value" id="cardRarity">â€”</div>
          </div>
        </div>
        <div id="cardPileBadge"></div>
      </div>
    </div>

    {% if simulated %}
    <div class="sim-box">
      <h3>âš¡ Simulate Scan</h3>
      <div class="search-wrap" style="margin-bottom:10px">
        <div class="sim-f" style="width:100%">
          <label>Search Scryfall</label>
          <input id="simSearch" placeholder="Type a card nameâ€¦"
                 oninput="debouncedSearch(this.value)"
                 autocomplete="off">
        </div>
        <div class="search-results" id="searchResults"></div>
      </div>
      <div class="sim-fields">
        <div class="sim-f">
          <label>Name</label>
          <input id="simName" value="Birds of Paradise" style="width:140px">
        </div>
        <div class="sim-f">
          <label>Scryfall ID</label>
          <input id="simSfId" value="" style="width:180px" placeholder="auto from search">
        </div>
        <div class="sim-f">
          <label>Price</label>
          <input id="simPrice" type="number" value="8.36" style="width:70px">
        </div>
        <div class="sim-f">
          <label>Rarity</label>
          <input id="simRarity" value="rare" style="width:70px">
        </div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn sm g" onclick="simScan()">Scan Card</button>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- â”€â”€ Motor Control â”€â”€ -->
  <div class="panel">
    <div class="panel-head"><span class="pip" style="background:var(--accent)"></span> Motor Control</div>

    <div class="indicators">
      <div class="ind"><span id="dotMotor" class="dot"></span><span id="lblMotor">Stopped</span></div>
      <div class="ind"><span id="dotBeam" class="dot"></span><span id="lblBeam">Beam clear</span></div>
      <div class="ind"><span id="dotCard" class="dot"></span><span id="lblCard">No card</span></div>
    </div>

    <div class="btn-row">
      <button class="btn g" onclick="motorFwd()">â–¶ Forward</button>
      <button class="btn b" onclick="motorRev()">â—€ Reverse</button>
      <button class="btn r" onclick="motorStop()">â–  Stop</button>
    </div>

    <div class="slider-row">
      <label>Speed</label>
      <input type="range" id="speedSlider" min="3" max="100" value="10"
             oninput="setSpeed(this.value)">
      <span class="slider-val" id="speedVal">1.0ms</span>
    </div>
    <div class="slider-row">
      <label>Steps</label>
      <input type="range" id="stepsSlider" min="0" max="2000" value="0" step="50"
             oninput="document.getElementById('stepsVal').textContent=this.value==0?'âˆ':this.value">
      <span class="slider-val" id="stepsVal">âˆ</span>
    </div>

    {% if simulated %}
    <div class="sim-box" style="margin-top:14px">
      <h3>âš¡ Beam Sensor Sim</h3>
      <div class="btn-row">
        <button class="btn sm" onclick="simBeam(true)">Block Beam</button>
        <button class="btn sm" onclick="simBeam(false)">Clear Beam</button>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- â”€â”€ Sorting Rules â”€â”€ -->
  <div class="panel">
    <div class="panel-head"><span class="pip" style="background:var(--yellow)"></span> Sorting Rules</div>
    <p style="font-size:12px;color:var(--text-dim);margin-bottom:10px">
      Evaluated top-to-bottom. First match wins. No match â†’ Pile 0 (default).
    </p>
    <div class="rules-scroll" id="rulesScroll"></div>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn sm g" onclick="addRule()">+ Add Rule</button>
      <button class="btn sm" onclick="saveRules()">ğŸ’¾ Save</button>
    </div>
  </div>

  <!-- â”€â”€ Scan Log â”€â”€ -->
  <div class="panel full-width">
    <div class="panel-head">
      <span class="pip" style="background:var(--blue)"></span> Scan Log
      <span style="flex:1"></span>
      <span style="font-family:var(--mono);font-size:22px;color:var(--white);font-weight:700" id="totalCount">0</span>
      <span style="font-size:10px;color:var(--text-dim);margin-left:4px">scanned</span>
    </div>
    <div class="btn-row" style="margin-bottom:8px">
      <button class="btn sm" onclick="window.open('/api/scans/export')">â†“ Export CSV</button>
      <button class="btn sm r" onclick="clearScans()">Clear</button>
    </div>
    <div class="log-scroll" id="logList">
      <div class="log-empty">No scans yet</div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const api = (url, opts={}) =>
  fetch(url, {
    headers: {'Content-Type':'application/json'},
    ...opts,
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  }).then(r => r.json());

// â”€â”€ Motor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSteps() { return parseInt(document.getElementById('stepsSlider').value) || 0; }
function motorFwd()  { api('/api/motor/forward', {method:'POST', body:{steps:getSteps()}}); }
function motorRev()  { api('/api/motor/reverse', {method:'POST', body:{steps:getSteps()||200}}); }
function motorStop() { api('/api/motor/stop',    {method:'POST'}); }
function setSpeed(v) {
  const d = v / 10000;
  document.getElementById('speedVal').textContent = (d*1000).toFixed(1)+'ms';
  api('/api/motor/speed', {method:'POST', body:{delay:d}});
}

// â”€â”€ Sim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function simBeam(b) { api('/api/sim/beam', {method:'POST', body:{blocked:b}}); }

function simScan() {
  api('/api/sim/scan', {method:'POST', body:{
    name:       document.getElementById('simName').value,
    scryfallId: document.getElementById('simSfId').value,
    price:      parseFloat(document.getElementById('simPrice').value) || 0,
    rarity:     document.getElementById('simRarity').value,
  }});
}

// â”€â”€ Scryfall Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchTimer = null;
function debouncedSearch(q) {
  clearTimeout(searchTimer);
  if (q.length < 2) { document.getElementById('searchResults').classList.remove('open'); return; }
  searchTimer = setTimeout(() => {
    fetch('/api/scryfall/search?q=' + encodeURIComponent(q))
      .then(r => r.json())
      .then(cards => {
        const el = document.getElementById('searchResults');
        if (!cards.length || cards.error) { el.classList.remove('open'); return; }
        el.innerHTML = cards.map(c => `
          <div class="sr-item" onclick="pickCard(${JSON.stringify(c).replace(/"/g,'&quot;')})">
            ${c.image ? `<img src="${c.image}" alt="">` : ''}
            <div>
              <div class="sr-name">${c.name}</div>
              <div class="sr-set">${c.set_name} Â· ${c.rarity}</div>
            </div>
          </div>
        `).join('');
        el.classList.add('open');
      });
  }, 300);
}

function pickCard(c) {
  document.getElementById('simName').value = c.name;
  document.getElementById('simSfId').value = c.id;
  document.getElementById('simRarity').value = c.rarity;
  document.getElementById('simSearch').value = c.name;
  document.getElementById('searchResults').classList.remove('open');
}

// Close search on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.search-wrap'))
    document.getElementById('searchResults')?.classList.remove('open');
});

// â”€â”€ Color pips HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function colorPips(arr) {
  if (!arr || !arr.length) return '<span style="color:var(--text-dim)">C</span>';
  return arr.map(c => `<span class="cpip ${c}">${c}</span>`).join('');
}

function rarityLabel(r) {
  const map = {common:'C', uncommon:'U', rare:'R', mythic:'M', special:'S', bonus:'B'};
  return map[r] || r || '?';
}

// â”€â”€ Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rules = [];
const FIELDS = [
  {v:'price',          l:'Price'},
  {v:'cmc',            l:'CMC'},
  {v:'rarity',         l:'Rarity'},
  {v:'color_identity', l:'Color Identity'},
  {v:'colors',         l:'Colors'},
  {v:'type_line',      l:'Type Line'},
  {v:'name',           l:'Name'},
  {v:'edition',        l:'Edition'},
  {v:'keywords',       l:'Keywords'},
  {v:'finish',         l:'Finish'},
];
const OPS = ['>', '<', '>=', '<=', '==', '!=', 'contains'];

function renderRules() {
  const el = document.getElementById('rulesScroll');
  el.innerHTML = rules.map((r,i) => `
    <div class="rule-card">
      <input class="rule-name" value="${r.name||''}" onchange="rules[${i}].name=this.value" placeholder="Label">
      <select class="rule-field" onchange="rules[${i}].field=this.value">
        ${FIELDS.map(f=>`<option value="${f.v}" ${r.field===f.v?'selected':''}>${f.l}</option>`).join('')}
      </select>
      <select class="rule-op" onchange="rules[${i}].operator=this.value">
        ${OPS.map(o=>`<option ${r.operator===o?'selected':''}>${o}</option>`).join('')}
      </select>
      <input class="rule-val" value="${r.value}" onchange="rules[${i}].value=isNaN(this.value)||this.value===''?this.value:parseFloat(this.value)" placeholder="value">
      <span class="rule-arrow">â†’</span>
      <input class="rule-pile" type="number" value="${r.pile}" onchange="rules[${i}].pile=parseInt(this.value)" title="Pile #">
      <button class="btn sm r rule-del" onclick="rules.splice(${i},1);renderRules()">âœ•</button>
    </div>
  `).join('');
}

function addRule() {
  rules.push({name:'New Rule', field:'price', operator:'>', value:1, pile:0});
  renderRules();
  document.getElementById('rulesScroll').scrollTop = 99999;
}

function saveRules() {
  api('/api/rules', {method:'POST', body:rules}).then(() => {
    const btn = event.target;
    btn.textContent = 'âœ“ Saved';
    setTimeout(() => btn.textContent = 'ğŸ’¾ Save', 1200);
  });
}

api('/api/rules').then(d => { rules = d; renderRules(); });

// â”€â”€ Scan Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog(scans) {
  const el = document.getElementById('logList');
  document.getElementById('totalCount').textContent = scans.length;
  if (!scans.length) { el.innerHTML = '<div class="log-empty">No scans yet</div>'; return; }
  el.innerHTML = scans.slice().reverse().map(s => {
    const ci = (s.color_identity||[]).join('');
    const time = s.timestamp ? s.timestamp.split('T')[1]?.substring(0,8) : '';
    return `
      <div class="log-row">
        <span class="log-name">${s.name}</span>
        <span class="log-detail">${ci || 'â€”'} Â· CMC ${s.cmc ?? '?'} Â· $${(s.price||0).toFixed(2)}</span>
        <span class="log-detail">${time}</span>
        <span class="log-pile">Pile ${s.pile}</span>
      </div>`;
  }).join('');
}

function clearScans() {
  if (confirm('Clear all scan history?'))
    api('/api/scans/clear', {method:'POST'}).then(poll);
}

// â”€â”€ Card display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCard(c) {
  if (!c) return;
  const wrap = document.getElementById('cardImgArea');
  if (c.image_uri) {
    wrap.innerHTML = `<img src="${c.image_uri}" alt="${c.name}">`;
  } else {
    wrap.innerHTML = `<div class="card-img-placeholder">${c.name}<br><span style="font-size:10px">No image available</span></div>`;
  }

  document.getElementById('cardInfo').style.display = 'block';
  document.getElementById('cardName').textContent = c.name;
  document.getElementById('cardType').textContent = c.type_line || c.cardType || '';
  document.getElementById('cardCmc').textContent = c.cmc ?? 'â€”';
  document.getElementById('cardPrice').textContent = '$' + (c.price || 0).toFixed(2);
  document.getElementById('cardColors').innerHTML = colorPips(c.color_identity);
  document.getElementById('cardRarity').textContent = rarityLabel(c.rarity);
  document.getElementById('cardPileBadge').innerHTML =
    `<span class="pile-badge">â†’ Pile ${c.pile}</span>`;
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastCardTs = '';

function poll() {
  api('/api/status').then(d => {
    // Motor indicators
    const dM = document.getElementById('dotMotor');
    const lM = document.getElementById('lblMotor');
    dM.className = 'dot ' + (d.running ? 'on' : '');
    lM.textContent = d.running ? (d.direction===1 ? 'Forward' : 'Reverse') : 'Stopped';

    const dB = document.getElementById('dotBeam');
    const lB = document.getElementById('lblBeam');
    dB.className = 'dot ' + (d.beam_blocked ? 'wrn' : '');
    lB.textContent = d.beam_blocked ? 'Blocked' : 'Clear';

    const dC = document.getElementById('dotCard');
    const lC = document.getElementById('lblCard');
    dC.className = 'dot ' + (d.card_detected ? 'err' : '');
    lC.textContent = d.card_detected ? 'Detected' : 'No card';

    // Header dots
    document.getElementById('hd1').style.background = d.running ? 'var(--accent)' : 'var(--surface3)';
    document.getElementById('hd2').style.background = d.beam_blocked ? 'var(--yellow)' : 'var(--surface3)';
    document.getElementById('hd3').style.background = d.card_detected ? 'var(--red)' : 'var(--surface3)';

    // Current card
    if (d.current_card && d.current_card.timestamp !== lastCardTs) {
      lastCardTs = d.current_card.timestamp;
      renderCard(d.current_card);
    }
  });

  api('/api/scans').then(renderLog);
}

setInterval(poll, 600);
poll();
</script>
</body>
</html>
