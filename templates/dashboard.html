<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Sorter</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@0,400;0,500;0,600;0,700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0c10; --sf:#12151c; --sf2:#1a1e28; --sf3:#222733;
  --brd:#2a2f3c; --tx:#c4c9d6; --txd:#5a6070; --wh:#eaedf4;
  --g:#4ade80; --gbg:#122a1e; --r:#f87171; --rbg:#2a1218;
  --y:#fbbf24; --ybg:#2a2412; --bl:#60a5fa; --blbg:#12202a;
  --pp:#a78bfa; --mono:'JetBrains Mono',monospace; --sans:'DM Sans',sans-serif;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:var(--sans);line-height:1.5}

.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid var(--brd);background:var(--sf)}
.logo{font-family:var(--mono);font-size:15px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--g)}
.badge{font-family:var(--mono);font-size:10px;padding:3px 10px;border-radius:99px;border:1px solid}
.badge.sim{color:var(--y);border-color:var(--y);background:var(--ybg)}
.badge.live{color:var(--g);border-color:var(--g);background:var(--gbg)}

.grid{display:grid;grid-template-columns:320px 1fr 1fr;gap:1px;background:var(--brd);min-height:calc(100vh - 48px)}
@media(max-width:1100px){.grid{grid-template-columns:1fr 1fr}.cpan{grid-column:1/-1;grid-row:1}}
@media(max-width:700px){.grid{grid-template-columns:1fr}}

.pan{background:var(--sf);padding:20px;overflow:hidden}
.ph{font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--txd);margin-bottom:14px;display:flex;align-items:center;gap:7px}
.pip{width:7px;height:7px;border-radius:2px;display:inline-block}
.fw{grid-column:1/-1}

.btn{font-family:var(--mono);font-size:12px;font-weight:600;padding:8px 16px;border:1px solid var(--brd);border-radius:6px;cursor:pointer;transition:all .12s;background:var(--sf2);color:var(--tx);white-space:nowrap}
.btn:hover{border-color:var(--txd);background:var(--sf3)}
.btn:active{transform:scale(.97)}
.btn.g{background:var(--gbg);border-color:var(--g);color:var(--g)}.btn.g:hover{background:var(--g);color:var(--bg)}
.btn.r{background:var(--rbg);border-color:var(--r);color:var(--r)}.btn.r:hover{background:var(--r);color:var(--bg)}
.btn.b{background:var(--blbg);border-color:var(--bl);color:var(--bl)}.btn.b:hover{background:var(--bl);color:var(--bg)}
.btn.sm{padding:5px 10px;font-size:11px}
.btn:disabled{opacity:.4;cursor:not-allowed}
.br{display:flex;gap:6px;flex-wrap:wrap}

.inds{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:14px}
.ind{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:12px}
.dot{width:9px;height:9px;border-radius:50%;background:var(--sf3);transition:all .2s;flex-shrink:0}
.dot.on{background:var(--g);box-shadow:0 0 8px var(--g)}
.dot.wrn{background:var(--y);box-shadow:0 0 8px var(--y)}
.dot.err{background:var(--r);box-shadow:0 0 8px var(--r)}

.srow{display:flex;align-items:center;gap:10px;margin-top:8px}
.srow label{font-family:var(--mono);font-size:11px;color:var(--txd);min-width:44px}
input[type=range]{-webkit-appearance:none;flex:1;height:3px;background:var(--brd);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--g);cursor:pointer}
.sv{font-family:var(--mono);font-size:11px;color:var(--wh);min-width:48px;text-align:right}

.cimg{width:100%;max-width:260px;aspect-ratio:488/680;border-radius:12px;overflow:hidden;background:var(--sf2);border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;margin:0 auto}
.cimg img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.cph{color:var(--txd);font-family:var(--mono);font-size:12px;text-align:center;padding:20px}

.cn{font-size:18px;font-weight:700;color:var(--wh);margin:10px 0 2px}
.ct{font-size:13px;color:var(--txd);font-style:italic;margin-bottom:8px}
.cmg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.mi{background:var(--sf2);border:1px solid var(--brd);border-radius:6px;padding:7px 9px}
.ml{font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--txd);margin-bottom:1px}
.mv{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--wh)}
.cpip{width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#000;border:2px solid rgba(255,255,255,.12);margin-right:2px}
.cpip.W{background:#f9f5dd}.cpip.U{background:#0e68ab;color:#fff}.cpip.B{background:#2b2a2a;color:#ccc}.cpip.R{background:#d3202a;color:#fff}.cpip.G{background:#00733e;color:#fff}.cpip.C{background:#8e8a86}
.pbadge{display:inline-block;font-family:var(--mono);font-size:12px;font-weight:700;padding:3px 12px;border-radius:99px;background:var(--gbg);color:var(--g);border:1px solid var(--g);margin-top:8px}

.rc{background:var(--sf2);border:1px solid var(--brd);border-radius:6px;padding:8px 10px;margin-bottom:5px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.rc select,.rc input{background:var(--bg);color:var(--tx);border:1px solid var(--brd);border-radius:4px;padding:4px 6px;font-family:var(--mono);font-size:11px}
.rc select:focus,.rc input:focus{outline:none;border-color:var(--g)}
.rn{width:90px}.rf{width:105px}.ro{width:72px}.rv{width:80px}.rp{width:44px;text-align:center}
.ra{font-family:var(--mono);font-size:11px;color:var(--txd);flex-shrink:0}
.rscr{max-height:350px;overflow-y:auto}

.lscr{max-height:320px;overflow-y:auto}
.lr{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--brd);font-size:12px;gap:6px}
.lr:last-child{border-bottom:none}
.lnm{font-weight:600;color:var(--wh);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ld{font-family:var(--mono);font-size:10px;color:var(--txd)}
.lp{font-family:var(--mono);font-size:10px;padding:2px 7px;border-radius:99px;background:var(--sf3);border:1px solid var(--brd);flex-shrink:0}
.le{color:var(--txd);font-style:italic;padding:14px;text-align:center}

.sbox{background:var(--ybg);border:1px solid rgba(251,191,36,.3);border-radius:8px;padding:12px;margin-top:12px}
.sbox h3{font-family:var(--mono);font-size:11px;color:var(--y);margin-bottom:8px;letter-spacing:.06em;text-transform:uppercase}
.sfs{display:flex;gap:6px;flex-wrap:wrap;align-items:end}
.sf{display:flex;flex-direction:column;gap:2px}
.sf label{font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:.06em;color:var(--txd)}
.sf input{background:var(--bg);color:var(--tx);border:1px solid var(--brd);border-radius:4px;padding:5px 8px;font-family:var(--mono);font-size:12px}
.sf input:focus{outline:none;border-color:var(--y)}

.swrap{position:relative}.sres{position:absolute;top:100%;left:0;right:0;background:var(--sf2);border:1px solid var(--brd);border-radius:0 0 6px 6px;max-height:240px;overflow-y:auto;z-index:100;display:none}
.sres.open{display:block}
.sri{display:flex;align-items:center;gap:8px;padding:7px 9px;cursor:pointer;border-bottom:1px solid var(--brd);transition:background .1s}
.sri:hover{background:var(--sf3)}
.sri img{width:28px;border-radius:3px;flex-shrink:0}
.sri .srn{font-size:12px;font-weight:600;color:var(--wh)}
.sri .srs{font-size:10px;color:var(--txd)}

/* Sequence panel */
.seq-step{background:var(--sf2);border:1px solid var(--brd);border-radius:8px;padding:12px;margin-bottom:8px}
.seq-step.active{border-color:var(--g);background:var(--gbg)}
.seq-step.disabled{opacity:.5}
.seq-num{font-family:var(--mono);font-size:10px;font-weight:700;color:var(--txd);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em}
.seq-desc{font-size:12px;color:var(--tx);margin-bottom:8px}
.seq-status{font-family:var(--mono);font-size:11px;padding:4px 8px;border-radius:4px;background:var(--bg);color:var(--txd);margin-top:6px;display:none}
.seq-status.show{display:block}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
</style>
</head>
<body>

<div class="hdr">
  <span class="logo">üÉè Card Sorter</span>
  <span class="badge {{ 'sim' if simulated else 'live' }}">{{ 'SIM' if simulated else 'LIVE' }}</span>
</div>

<div class="grid">

  <!-- ‚ïê‚ïê‚ïê Current Card ‚ïê‚ïê‚ïê -->
  <div class="pan cpan" style="grid-row:1/3">
    <div class="ph"><span class="pip" style="background:var(--pp)"></span> Current Card</div>
    <div class="cimg" id="cardImgArea"><div class="cph">Scan a card to see it here</div></div>
    <div id="cardInfo" style="display:none">
      <div class="cn" id="cName"></div>
      <div class="ct" id="cType"></div>
      <div class="cmg">
        <div class="mi"><div class="ml">CMC</div><div class="mv" id="cCmc">‚Äî</div></div>
        <div class="mi"><div class="ml">Price</div><div class="mv" id="cPrice">‚Äî</div></div>
        <div class="mi"><div class="ml">Colors</div><div class="mv" id="cColors">‚Äî</div></div>
        <div class="mi"><div class="ml">Rarity</div><div class="mv" id="cRarity">‚Äî</div></div>
      </div>
      <div id="cPile"></div>
    </div>
    {% if simulated %}
    <div class="sbox">
      <h3>‚ö° Simulate Scan</h3>
      <div class="swrap" style="margin-bottom:8px">
        <div class="sf" style="width:100%">
          <label>Search Scryfall</label>
          <input id="simSearch" placeholder="Type a card name‚Ä¶" oninput="debSearch(this.value)" autocomplete="off">
        </div>
        <div class="sres" id="searchRes"></div>
      </div>
      <div class="sfs">
        <div class="sf"><label>Name</label><input id="simName" value="Birds of Paradise" style="width:130px"></div>
        <div class="sf"><label>Scryfall ID</label><input id="simSfId" value="" style="width:160px" placeholder="from search"></div>
        <div class="sf"><label>Price</label><input id="simPrice" type="number" value="8.36" style="width:65px"></div>
        <div class="sf"><label>Rarity</label><input id="simRarity" value="rare" style="width:65px"></div>
      </div>
      <div class="br" style="margin-top:8px"><button class="btn sm g" onclick="simScan()">Scan Card</button></div>
    </div>
    {% endif %}
  </div>

  <!-- ‚ïê‚ïê‚ïê Sequence Control ‚ïê‚ïê‚ïê -->
  <div class="pan">
    <div class="ph"><span class="pip" style="background:var(--g)"></span> Sorting Sequence</div>
    <div class="inds" id="beamInds"></div>

    <div class="seq-step" id="ss1">
      <div class="seq-num">Step 1 ‚Äî Home</div>
      <div class="seq-desc">Run stepper 1 CCW until beam break 0 is hit</div>
      <div class="br">
        <button class="btn sm g" onclick="seqStep(1)">‚ñ∂ Run Step 1</button>
        <button class="btn sm r" onclick="seqStop()">‚ñ† Stop</button>
      </div>
      <div class="seq-status" id="ss1status"></div>
    </div>

    <div class="seq-step disabled" id="ss2">
      <div class="seq-num">Step 2 ‚Äî Scan Position</div>
      <div class="seq-desc">Oscillate stepper 1 CW/CCW between beam 0 and 1 until Delver scans</div>
      <div class="br">
        <button class="btn sm" onclick="seqStep(2)" disabled>‚ñ∂ Run Step 2</button>
      </div>
      <div class="seq-status" id="ss2status"></div>
    </div>

    <div class="seq-step disabled" id="ss3">
      <div class="seq-num">Step 3 ‚Äî Sort to Pile</div>
      <div class="seq-desc">Run stepper 1 CW + stepper 2 CW until target pile beam triggers</div>
      <div class="br">
        <button class="btn sm" onclick="seqStep(3)" disabled>‚ñ∂ Run Step 3</button>
      </div>
      <div class="seq-status" id="ss3status"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Manual Motor Control ‚ïê‚ïê‚ïê -->
  <div class="pan">
    <div class="ph"><span class="pip" style="background:var(--bl)"></span> Manual Motor</div>
    <p style="font-size:12px;color:var(--txd);margin-bottom:10px">Direct stepper control for testing</p>

    <div class="srow" style="margin-top:0">
      <label>Stepper</label>
      <select id="mStepper" style="background:var(--bg);color:var(--tx);border:1px solid var(--brd);border-radius:4px;padding:4px 8px;font-family:var(--mono);font-size:12px">
        <option value="1">Stepper 1</option>
        <option value="2">Stepper 2</option>
      </select>
    </div>
    <div class="srow">
      <label>Steps</label>
      <input type="range" id="mSteps" min="10" max="2000" value="200" step="10" oninput="document.getElementById('mStepsV').textContent=this.value">
      <span class="sv" id="mStepsV">200</span>
    </div>
    <div class="srow">
      <label>Speed</label>
      <input type="range" id="mDelay" min="3" max="100" value="10" oninput="document.getElementById('mDelayV').textContent=(this.value/10000*1000).toFixed(1)+'ms'">
      <span class="sv" id="mDelayV">1.0ms</span>
    </div>
    <div class="br" style="margin-top:12px">
      <button class="btn g" onclick="manualStep(1)">‚ñ∂ CW</button>
      <button class="btn b" onclick="manualStep(-1)">‚óÄ CCW</button>
      <button class="btn" onclick="manualRunBeam(-1,'beam0')">‚èé Home (‚Üíbeam0)</button>
    </div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--txd);margin-top:8px" id="motorResult"></div>

    {% if simulated %}
    <div class="sbox">
      <h3>‚ö° Sim Beam Breaks</h3>
      <div class="br" id="simBeamBtns"></div>
    </div>
    {% endif %}
  </div>

  <!-- ‚ïê‚ïê‚ïê Sorting Rules ‚ïê‚ïê‚ïê -->
  <div class="pan">
    <div class="ph"><span class="pip" style="background:var(--y)"></span> Sorting Rules</div>
    <p style="font-size:11px;color:var(--txd);margin-bottom:8px">Top-to-bottom, first match wins. No match ‚Üí Pile 0.</p>
    <div class="rscr" id="rulesScroll"></div>
    <div class="br" style="margin-top:8px">
      <button class="btn sm g" onclick="addRule()">+ Add Rule</button>
      <button class="btn sm" onclick="saveRules()">üíæ Save</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Scan Log ‚ïê‚ïê‚ïê -->
  <div class="pan fw">
    <div class="ph">
      <span class="pip" style="background:var(--bl)"></span> Scan Log
      <span style="flex:1"></span>
      <span style="font-family:var(--mono);font-size:20px;color:var(--wh);font-weight:700" id="totalCt">0</span>
      <span style="font-size:10px;color:var(--txd);margin-left:4px">scanned</span>
    </div>
    <div class="br" style="margin-bottom:6px">
      <button class="btn sm" onclick="window.open('/api/scans/export')">‚Üì CSV</button>
      <button class="btn sm r" onclick="clearScans()">Clear</button>
    </div>
    <div class="lscr" id="logList"><div class="le">No scans yet</div></div>
  </div>
</div>

<script>
const api=(u,o={})=>fetch(u,{headers:{'Content-Type':'application/json'},...o,body:o.body?JSON.stringify(o.body):undefined}).then(r=>r.json());

// Motor
function manualStep(dir){
  const s=document.getElementById('mStepper').value;
  const steps=parseInt(document.getElementById('mSteps').value);
  const delay=parseInt(document.getElementById('mDelay').value)/10000;
  document.getElementById('motorResult').textContent='Running...';
  api('/api/motor/step',{method:'POST',body:{stepper:parseInt(s),direction:dir,steps,delay}})
    .then(d=>{document.getElementById('motorResult').textContent=d.ok?`Done: ${d.steps_taken} steps`:`Error: ${d.error}`})
    .catch(e=>{document.getElementById('motorResult').textContent='Request failed'});
}
function manualRunBeam(dir,beam){
  const s=document.getElementById('mStepper').value;
  const delay=parseInt(document.getElementById('mDelay').value)/10000;
  document.getElementById('motorResult').textContent='Running until beam...';
  api('/api/motor/run_until_beam',{method:'POST',body:{stepper:parseInt(s),direction:dir,beam,delay}})
    .then(d=>{document.getElementById('motorResult').textContent=d.ok?(d.success?`Beam hit after ${d.steps_taken} steps`:`Beam NOT hit (${d.steps_taken} steps)`):`Error: ${d.error}`})
    .catch(e=>{document.getElementById('motorResult').textContent='Request failed'});
}

// Sequence
function seqStep(n){
  api(`/api/seq/step${n}`,{method:'POST'}).then(d=>{
    const el=document.getElementById(`ss${n}status`);
    el.classList.add('show');
    el.textContent=d.ok?'Started...':d.msg||d.error||'Failed';
    el.style.color=d.ok?'var(--g)':'var(--r)';
  });
}
function seqStop(){api('/api/seq/stop',{method:'POST'})}

// Sim
function simBeam(beam,blocked){api('/api/sim/beam',{method:'POST',body:{beam,blocked}})}
function simScan(){
  api('/api/sim/scan',{method:'POST',body:{
    name:document.getElementById('simName').value,
    scryfallId:document.getElementById('simSfId').value,
    price:parseFloat(document.getElementById('simPrice').value)||0,
    rarity:document.getElementById('simRarity').value,
  }});
}

// Scryfall search
let st=null;
function debSearch(q){
  clearTimeout(st);
  if(q.length<2){document.getElementById('searchRes').classList.remove('open');return}
  st=setTimeout(()=>{
    fetch('/api/scryfall/search?q='+encodeURIComponent(q)).then(r=>r.json()).then(cards=>{
      const el=document.getElementById('searchRes');
      if(!cards.length||cards.error){el.classList.remove('open');return}
      el.innerHTML=cards.map(c=>`<div class="sri" onclick='pickCard(${JSON.stringify(c).replace(/'/g,"&#39;")})'>${c.image?`<img src="${c.image}">`:''}<div><div class="srn">${c.name}</div><div class="srs">${c.set_name} ¬∑ ${c.rarity}</div></div></div>`).join('');
      el.classList.add('open');
    });
  },300);
}
function pickCard(c){
  document.getElementById('simName').value=c.name;
  document.getElementById('simSfId').value=c.id;
  document.getElementById('simRarity').value=c.rarity;
  document.getElementById('simSearch').value=c.name;
  document.getElementById('searchRes').classList.remove('open');
}
document.addEventListener('click',e=>{if(!e.target.closest('.swrap'))document.getElementById('searchRes')?.classList.remove('open')});

// Color pips
function cpips(a){
  if(!a||!a.length)return'<span class="cpip C">C</span>';
  return a.map(c=>`<span class="cpip ${c}">${c}</span>`).join('');
}
function rl(r){return{common:'Common',uncommon:'Uncommon',rare:'Rare',mythic:'Mythic'}[r]||r||'?'}

// Rules
let rules=[];
const FIELDS=[{v:'price',l:'Price'},{v:'cmc',l:'CMC'},{v:'rarity',l:'Rarity'},{v:'color_identity',l:'Color ID'},{v:'colors',l:'Colors'},{v:'type_line',l:'Type Line'},{v:'name',l:'Name'},{v:'edition',l:'Edition'},{v:'keywords',l:'Keywords'},{v:'finish',l:'Finish'}];
const OPS=['>','<','>=','<=','==','!=','contains'];
function renderRules(){
  document.getElementById('rulesScroll').innerHTML=rules.map((r,i)=>`<div class="rc"><input class="rn" value="${r.name||''}" onchange="rules[${i}].name=this.value" placeholder="Label"><select class="rf" onchange="rules[${i}].field=this.value">${FIELDS.map(f=>`<option value="${f.v}"${r.field===f.v?' selected':''}>${f.l}</option>`).join('')}</select><select class="ro" onchange="rules[${i}].operator=this.value">${OPS.map(o=>`<option${r.operator===o?' selected':''}>${o}</option>`).join('')}</select><input class="rv" value="${r.value}" onchange="rules[${i}].value=isNaN(this.value)||this.value===''?this.value:parseFloat(this.value)" placeholder="value"><span class="ra">‚Üí</span><input class="rp" type="number" value="${r.pile}" onchange="rules[${i}].pile=parseInt(this.value)" title="Pile #"><button class="btn sm r" onclick="rules.splice(${i},1);renderRules()">‚úï</button></div>`).join('');
}
function addRule(){rules.push({name:'New',field:'price',operator:'>',value:1,pile:0});renderRules()}
function saveRules(){api('/api/rules',{method:'POST',body:rules}).then(()=>{alert('Saved!')})}
api('/api/rules').then(d=>{rules=d;renderRules()});

// Log
function renderLog(scans){
  document.getElementById('totalCt').textContent=scans.length;
  const el=document.getElementById('logList');
  if(!scans.length){el.innerHTML='<div class="le">No scans yet</div>';return}
  el.innerHTML=scans.slice().reverse().map(s=>{
    const ci=(s.color_identity||[]).join('');
    const t=s.timestamp?s.timestamp.split('T')[1]?.substring(0,8):'';
    return`<div class="lr"><span class="lnm">${s.name}</span><span class="ld">${ci||'C'} ¬∑ CMC ${s.cmc??'?'} ¬∑ $${(s.price||0).toFixed(2)}</span><span class="ld">${t}</span><span class="lp">Pile ${s.pile}</span></div>`;
  }).join('');
}
function clearScans(){if(confirm('Clear?'))api('/api/scans/clear',{method:'POST'}).then(poll)}

// Card display
let lastTs='';
function renderCard(c){
  if(!c)return;
  const w=document.getElementById('cardImgArea');
  w.innerHTML=c.image_uri?`<img src="${c.image_uri}" alt="${c.name}">`:`<div class="cph">${c.name}<br><span style="font-size:10px">${c.scryfallId?'Image loading...':'No Scryfall ID'}</span></div>`;
  document.getElementById('cardInfo').style.display='block';
  document.getElementById('cName').textContent=c.name;
  document.getElementById('cType').textContent=c.type_line||c.cardType||'';
  document.getElementById('cCmc').textContent=c.cmc??'‚Äî';
  document.getElementById('cPrice').textContent='$'+(c.price||0).toFixed(2);
  document.getElementById('cColors').innerHTML=cpips(c.color_identity);
  document.getElementById('cRarity').textContent=rl(c.rarity);
  document.getElementById('cPile').innerHTML=`<span class="pbadge">‚Üí Pile ${c.pile}</span>`;
}

// Polling
function poll(){
  api('/api/status').then(d=>{
    // Beams
    const bi=document.getElementById('beamInds');
    bi.innerHTML=Object.entries(d.beams||{}).map(([n,b])=>`<div class="ind"><span class="dot ${b?'wrn':''}"></span>${n}: ${b?'BLOCKED':'clear'}</div>`).join('');

    // Sim beam buttons
    const sb=document.getElementById('simBeamBtns');
    if(sb){
      const beams=Object.keys(d.beams||{});
      if(!sb.children.length){
        sb.innerHTML=beams.map(b=>`<button class="btn sm" onclick="simBeam('${b}',true)">Block ${b}</button><button class="btn sm" onclick="simBeam('${b}',false)">Clear ${b}</button>`).join('');
      }
    }

    // Sequence status
    if(d.seq_status){
      const s1=document.getElementById('ss1status');
      s1.classList.add('show');
      s1.textContent=d.seq_status;
      s1.style.color=d.seq_error?'var(--r)':'var(--g)';
    }

    // Card
    if(d.current_card&&d.current_card.timestamp!==lastTs){
      lastTs=d.current_card.timestamp;
      renderCard(d.current_card);
    }
  });
  api('/api/scans').then(renderLog);
}
setInterval(poll,700);
poll();
</script>
</body>
</html>